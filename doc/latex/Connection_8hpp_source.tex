\hypertarget{Connection_8hpp_source}{}\doxysection{Connection.\+hpp}
\label{Connection_8hpp_source}\index{src/Connection.hpp@{src/Connection.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 }
\DoxyCodeLine{2 \textcolor{comment}{//}}
\DoxyCodeLine{3 \textcolor{comment}{//    Connection.hpp specifies a class that represent a connection and define}}
\DoxyCodeLine{4 \textcolor{comment}{//    the wrapper function for input-\/output socket operation using an internal}}
\DoxyCodeLine{5 \textcolor{comment}{//    buffer}}
\DoxyCodeLine{6 \textcolor{comment}{//}}
\DoxyCodeLine{8 \textcolor{comment}{}\textcolor{preprocessor}{\#ifndef CONNECTION\_HPP}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#define CONNECTION\_HPP}}
\DoxyCodeLine{10 }
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <memory>}}
\DoxyCodeLine{12 }
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <boost/asio.hpp>}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <boost/bind/bind.hpp>}}
\DoxyCodeLine{15 }
\DoxyCodeLine{16 }
\DoxyCodeLine{17 \textcolor{keyword}{class }\mbox{\hyperlink{classConnection}{Connection}} \{}
\DoxyCodeLine{18   \textcolor{keyword}{public}:}
\DoxyCodeLine{19     \mbox{\hyperlink{classConnection}{Connection}}(boost::asio::io\_context \&);}
\DoxyCodeLine{20     \mbox{\hyperlink{classConnection}{\string~Connection}}(\textcolor{keywordtype}{void});}
\DoxyCodeLine{21     \textcolor{keywordtype}{void} send(\textcolor{keywordtype}{void});}
\DoxyCodeLine{22     \textcolor{keywordtype}{void} receive(\textcolor{keywordtype}{void});}
\DoxyCodeLine{23     \textcolor{keywordtype}{void} load\_data(\textcolor{keyword}{const} std::string \&);}
\DoxyCodeLine{24     \textcolor{keywordtype}{void} load\_data(\textcolor{keyword}{const} std::vector<int> \&);}
\DoxyCodeLine{25     \textcolor{keywordtype}{void} load\_data(\textcolor{keyword}{const} std::vector<unsigned char> \&);}
\DoxyCodeLine{26     \textcolor{keywordtype}{void} load\_data(\textcolor{keyword}{const} boost::asio::const\_buffer \&);}
\DoxyCodeLine{27     \textcolor{keyword}{const} std::shared\_ptr<char[]> unload\_data(\textcolor{keywordtype}{void}) \textcolor{keyword}{const};}
\DoxyCodeLine{28     boost::asio::ip::tcp::socket\& get\_socket(\textcolor{keywordtype}{void});}
\DoxyCodeLine{29     \textcolor{keywordtype}{bool} first\_operation\_ended(\textcolor{keywordtype}{void});}
\DoxyCodeLine{30     \textcolor{keywordtype}{bool} is\_ready\_to\_receive(\textcolor{keywordtype}{void});}
\DoxyCodeLine{31     \textcolor{keywordtype}{bool} is\_persistant(\textcolor{keywordtype}{void});}
\DoxyCodeLine{32     \textcolor{keywordtype}{void} set\_persistant(\textcolor{keywordtype}{void});}
\DoxyCodeLine{33   \textcolor{keyword}{private}:}
\DoxyCodeLine{34     \textcolor{comment}{// Variables}}
\DoxyCodeLine{35     boost::asio::ip::tcp::socket m\_socket;}
\DoxyCodeLine{36     std::unique\_ptr<boost::asio::mutable\_buffer> m\_internal\_receive\_buffer\_ptr;}
\DoxyCodeLine{37     std::unique\_ptr<boost::asio::const\_buffer> m\_internal\_send\_buffer\_ptr;}
\DoxyCodeLine{38     \textcolor{keywordtype}{bool} m\_send\_error = \textcolor{keyword}{false};}
\DoxyCodeLine{39     \textcolor{keywordtype}{bool} m\_receive\_error = \textcolor{keyword}{false};}
\DoxyCodeLine{40     \textcolor{keywordtype}{bool} m\_first\_operation\_ended = \textcolor{keyword}{false};}
\DoxyCodeLine{41     \textcolor{keywordtype}{bool} m\_persistant = \textcolor{keyword}{false};}
\DoxyCodeLine{42     \textcolor{comment}{// Functions}}
\DoxyCodeLine{43     \textcolor{keywordtype}{void} m\_handle\_send(\textcolor{keyword}{const} boost::system::error\_code\&,}
\DoxyCodeLine{44                        \textcolor{keywordtype}{size\_t} \textcolor{comment}{/*bytes\_transferred*/});}
\DoxyCodeLine{45     \textcolor{keywordtype}{void} m\_handle\_receive(\textcolor{keyword}{const} boost::system::error\_code\&, \textcolor{keywordtype}{size\_t});}
\DoxyCodeLine{46 \};}
\DoxyCodeLine{47 }
\DoxyCodeLine{48 Connection::Connection(boost::asio::io\_context\& executor) : m\_socket(executor) \{\}}
\DoxyCodeLine{49 }
\DoxyCodeLine{50 Connection::\string~Connection(\textcolor{keywordtype}{void}) \{}
\DoxyCodeLine{51   std::cerr << \textcolor{stringliteral}{"{}INFO: Connection: user "{}} << m\_socket.remote\_endpoint().address() }
\DoxyCodeLine{52             << \textcolor{stringliteral}{"{}: destructor: socket close."{}} << std::endl;}
\DoxyCodeLine{53   m\_socket.close();}
\DoxyCodeLine{54 \}}
\DoxyCodeLine{55 }
\DoxyCodeLine{56 \textcolor{keywordtype}{void} Connection::m\_handle\_send(\textcolor{keyword}{const} boost::system::error\_code\& error, \textcolor{keywordtype}{size\_t} bytes\_transferred)\{}
\DoxyCodeLine{57   std::cerr << \textcolor{stringliteral}{"{}INFO: Connection: user "{}} << m\_socket.remote\_endpoint().address() }
\DoxyCodeLine{58             << \textcolor{stringliteral}{"{}: m\_handle\_send: bytes transferred = "{}} << bytes\_transferred }
\DoxyCodeLine{59             << std::endl;}
\DoxyCodeLine{60   \textcolor{keywordflow}{if} (!error)\{}
\DoxyCodeLine{61     m\_internal\_send\_buffer\_ptr.release();}
\DoxyCodeLine{62     m\_first\_operation\_ended = \textcolor{keyword}{true};}
\DoxyCodeLine{63   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{64     m\_send\_error = \textcolor{keyword}{true}; \textcolor{comment}{//va implementato come controllo nei send successivi notifica utente}}
\DoxyCodeLine{65     std::cerr << \textcolor{stringliteral}{"{}Error"{}} << std::endl;}
\DoxyCodeLine{66   \}}
\DoxyCodeLine{67 \}}
\DoxyCodeLine{68 }
\DoxyCodeLine{69 \textcolor{keywordtype}{void} Connection::m\_handle\_receive(\textcolor{keyword}{const} boost::system::error\_code\& error, \textcolor{keywordtype}{size\_t} bytes\_transferred)\{}
\DoxyCodeLine{70   std::cerr << \textcolor{stringliteral}{"{}INFO: Connection: user "{}} << m\_socket.remote\_endpoint().address() }
\DoxyCodeLine{71             << \textcolor{stringliteral}{"{}: m\_handle\_receive: bytes transferred = "{}} << bytes\_transferred }
\DoxyCodeLine{72             << std::endl;}
\DoxyCodeLine{73   \textcolor{keywordflow}{if} (!error)\{}
\DoxyCodeLine{74    m\_internal\_receive\_buffer\_ptr.release();}
\DoxyCodeLine{75    m\_first\_operation\_ended = \textcolor{keyword}{true};}
\DoxyCodeLine{76   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{77     m\_receive\_error = \textcolor{keyword}{true}; \textcolor{comment}{//va implementato come controllo nei receive successivi notifica utente}}
\DoxyCodeLine{78     std::cerr << \textcolor{stringliteral}{"{}Error"{}} << std::endl;}
\DoxyCodeLine{79   \}}
\DoxyCodeLine{80 \}}
\DoxyCodeLine{81 }
\DoxyCodeLine{82 }
\DoxyCodeLine{83 \textcolor{keywordtype}{void} Connection::send(\textcolor{keywordtype}{void}) \{}
\DoxyCodeLine{84   m\_socket.async\_send(*m\_internal\_send\_buffer\_ptr, }
\DoxyCodeLine{85                       boost::bind(\&Connection::m\_handle\_send, \textcolor{keyword}{this}, }
\DoxyCodeLine{86                         boost::asio::placeholders::error,}
\DoxyCodeLine{87                         boost::asio::placeholders::bytes\_transferred));}
\DoxyCodeLine{88 \}}
\DoxyCodeLine{89 }
\DoxyCodeLine{90 \textcolor{keywordtype}{void} Connection::receive(\textcolor{keywordtype}{void}) \{}
\DoxyCodeLine{91   m\_internal\_receive\_buffer\_ptr.reset(\textcolor{keyword}{new} boost::asio::mutable\_buffer(}
\DoxyCodeLine{92     \textcolor{keyword}{new} \textcolor{keywordtype}{char}[m\_socket.available()], m\_socket.available()}
\DoxyCodeLine{93   ));}
\DoxyCodeLine{94   m\_socket.async\_receive(*m\_internal\_receive\_buffer\_ptr,}
\DoxyCodeLine{95                         boost::bind(\&Connection::m\_handle\_receive, \textcolor{keyword}{this}, }
\DoxyCodeLine{96                                 boost::asio::placeholders::error,}
\DoxyCodeLine{97                                 boost::asio::placeholders::bytes\_transferred));}
\DoxyCodeLine{98 \}}
\DoxyCodeLine{99 }
\DoxyCodeLine{100 \textcolor{keywordtype}{void} Connection::load\_data(\textcolor{keyword}{const} std::string \&input) \{}
\DoxyCodeLine{101   m\_internal\_send\_buffer\_ptr.reset(\textcolor{keyword}{new} boost::asio::const\_buffer(input.data(), }
\DoxyCodeLine{102                                                                  input.size()));}
\DoxyCodeLine{103 \}}
\DoxyCodeLine{104 }
\DoxyCodeLine{105 \textcolor{keywordtype}{void} Connection::load\_data(\textcolor{keyword}{const} std::vector<int> \&input) \{}
\DoxyCodeLine{106   m\_internal\_send\_buffer\_ptr.reset(\textcolor{keyword}{new} boost::asio::const\_buffer(input.data(), }
\DoxyCodeLine{107                                                                  input.size()));}
\DoxyCodeLine{108 \}}
\DoxyCodeLine{109 }
\DoxyCodeLine{110 \textcolor{keywordtype}{void} Connection::load\_data(\textcolor{keyword}{const} std::vector<unsigned char> \&input) \{}
\DoxyCodeLine{111   m\_internal\_send\_buffer\_ptr.reset(\textcolor{keyword}{new} boost::asio::const\_buffer(input.data(), }
\DoxyCodeLine{112                                                                  input.size()));}
\DoxyCodeLine{113 \}}
\DoxyCodeLine{114 }
\DoxyCodeLine{115 \textcolor{keywordtype}{void} Connection::load\_data(\textcolor{keyword}{const} boost::asio::const\_buffer \&input) \{}
\DoxyCodeLine{116   m\_internal\_send\_buffer\_ptr.reset(\textcolor{keyword}{new} boost::asio::const\_buffer(input.data(), }
\DoxyCodeLine{117                                                                  input.size()));}
\DoxyCodeLine{118 \}}
\DoxyCodeLine{119 }
\DoxyCodeLine{120 \textcolor{keyword}{const} std::shared\_ptr<char[]> Connection::unload\_data(\textcolor{keywordtype}{void})\textcolor{keyword}{ const }\{}
\DoxyCodeLine{121   \textcolor{keywordtype}{size\_t} size = m\_internal\_receive\_buffer\_ptr-\/>size();}
\DoxyCodeLine{122   std::shared\_ptr<char[]> ret\_ptr;}
\DoxyCodeLine{123   ret\_ptr.reset(\textcolor{keyword}{new} \textcolor{keywordtype}{char}[size]);}
\DoxyCodeLine{124   ::memcpy(ret\_ptr.get(), m\_internal\_receive\_buffer\_ptr-\/>data(), }
\DoxyCodeLine{125                           m\_internal\_receive\_buffer\_ptr-\/>size());}
\DoxyCodeLine{126   \textcolor{keywordflow}{return} ret\_ptr;}
\DoxyCodeLine{127 \}}
\DoxyCodeLine{128 }
\DoxyCodeLine{129 boost::asio::ip::tcp::socket\& Connection::get\_socket(\textcolor{keywordtype}{void}) \{}
\DoxyCodeLine{130   \textcolor{keywordflow}{return} m\_socket;}
\DoxyCodeLine{131 \}}
\DoxyCodeLine{132  }
\DoxyCodeLine{133 \textcolor{keywordtype}{bool} Connection::first\_operation\_ended(\textcolor{keywordtype}{void}) \{}
\DoxyCodeLine{134   \textcolor{keywordflow}{return} m\_first\_operation\_ended;}
\DoxyCodeLine{135 \}}
\DoxyCodeLine{136 }
\DoxyCodeLine{137 \textcolor{keywordtype}{bool} Connection::is\_ready\_to\_receive(\textcolor{keywordtype}{void}) \{}
\DoxyCodeLine{138   \textcolor{keywordflow}{if}(m\_socket.available() > 0) \{}
\DoxyCodeLine{139     \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{140   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{141     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{142   \}}
\DoxyCodeLine{143 \}}
\DoxyCodeLine{144     }
\DoxyCodeLine{145 \textcolor{keywordtype}{void} Connection::set\_persistant(\textcolor{keywordtype}{void}) \{}
\DoxyCodeLine{146   m\_persistant = \textcolor{keyword}{true};}
\DoxyCodeLine{147 \}}
\DoxyCodeLine{148     }
\DoxyCodeLine{149 \textcolor{keywordtype}{bool} Connection::is\_persistant(\textcolor{keywordtype}{void}) \{}
\DoxyCodeLine{150   \textcolor{keywordflow}{return} m\_persistant;}
\DoxyCodeLine{151 \}}
\DoxyCodeLine{152 }
\DoxyCodeLine{153 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
